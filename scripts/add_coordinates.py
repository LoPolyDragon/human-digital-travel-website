import json
import requests
import time
from collections import defaultdict

def get_coordinates_from_city_name(city_name):
    """
    根据城市名获取坐标
    这里使用一个简单的中国主要城市坐标映射
    """
    # 中国主要城市坐标数据
    city_coords = {
        '北京': (39.9042, 116.4074),
        '上海': (31.2304, 121.4737),
        '广州': (23.1291, 113.2644),
        '深圳': (22.5431, 114.0579),
        '天津': (39.0851, 117.1995),
        '重庆': (29.5647, 106.5507),
        '成都': (30.5728, 104.0668),
        '杭州': (30.2741, 120.1551),
        '南京': (32.0603, 118.7969),
        '西安': (34.2655, 108.9540),
        '武汉': (30.5928, 114.3055),
        '济南': (36.6512, 117.1201),
        '郑州': (34.7466, 113.6254),
        '沈阳': (41.8057, 123.4315),
        '长春': (43.8171, 125.3235),
        '哈尔滨': (45.7732, 126.6571),
        '石家庄': (38.0428, 114.5149),
        '太原': (37.8570, 112.5489),
        '呼和浩特': (40.8183, 111.6621),
        '南宁': (22.8170, 108.3669),
        '昆明': (25.0389, 102.7183),
        '拉萨': (29.6520, 91.1723),
        '兰州': (36.0611, 103.8343),
        '西宁': (36.6171, 101.7782),
        '银川': (38.4872, 106.2309),
        '乌鲁木齐': (43.8256, 87.6168),
        '长沙': (28.2282, 112.9388),
        '福州': (26.0745, 119.2965),
        '南昌': (28.6820, 115.8581),
        '合肥': (31.8206, 117.2272),
        '大连': (38.9122, 121.6022),
        '青岛': (36.0671, 120.3826),
        '厦门': (24.4798, 118.0894),
        '宁波': (29.8683, 121.5440),
        '苏州': (31.2989, 120.5853),
        '无锡': (31.4910, 120.3119),
        '常州': (31.7718, 119.9742),
        '扬州': (32.3932, 119.4215),
        '南通': (32.0166, 120.8866),
        '镇江': (32.1862, 119.4252),
        '温州': (28.0006, 120.6721),
        '嘉兴': (30.7469, 120.7507),
        '湖州': (30.8703, 120.0873),
        '绍兴': (30.0023, 120.5810),
        '金华': (29.1028, 119.6529),
        '衢州': (28.9569, 118.8739),
        '台州': (28.6568, 121.4282),
        '丽水': (28.4517, 119.9219),
        '保定': (38.8740, 115.4648),
        '唐山': (39.6243, 118.1944),
        '邯郸': (36.6256, 114.5389),
        '邢台': (37.0682, 114.5086),
        '沧州': (38.3037, 116.8575),
        '承德': (40.9517, 117.9632),
        '张家口': (40.8111, 114.8794),
        '廊坊': (39.5241, 116.7044),
        '衡水': (37.7161, 115.6756),
        '秦皇岛': (39.9350, 119.6006),
        '大同': (40.0690, 113.3006),
        '阳泉': (37.8695, 113.5633),
        '长治': (36.1951, 113.1163),
        '晋城': (35.5021, 112.8516),
        '朔州': (39.3313, 112.4336),
        '晋中': (37.6961, 112.7536),
        '运城': (35.0228, 110.9933),
        '忻州': (38.4172, 112.7343),
        '临汾': (36.0881, 111.5198),
        '吕梁': (37.5179, 111.1340),
        '包头': (40.6582, 109.8407),
        '鄂尔多斯': (39.6086, 109.7817),
        '通辽': (43.6527, 122.2438),
        '赤峰': (42.2755, 118.8868),
        '呼伦贝尔': (49.2117, 119.7658),
        '巴彦淖尔': (40.7524, 107.3872),
        '乌兰察布': (41.0341, 113.1148),
        '兴安盟': (46.0768, 122.0370),
        '锡林郭勒盟': (43.9440, 116.0470),
        '阿拉善盟': (38.8518, 105.7066),
        '大庆': (46.5907, 125.1112),
        '齐齐哈尔': (47.3543, 123.9180),
        '牡丹江': (44.5517, 129.6330),
        '佳木斯': (46.8137, 130.3186),
        '鸡西': (45.3000, 130.9750),
        '双鸭山': (46.6434, 131.1572),
        '伊春': (47.7248, 128.8414),
        '七台河': (45.7713, 131.0159),
        '鹤岗': (47.3516, 130.2970),
        '黑河': (50.2495, 127.4990),
        '绥化': (46.6374, 126.9929),
        '大兴安岭': (50.4177, 124.7119),
        '常德': (29.0308, 111.6788),
        '张家界': (29.1274, 110.4784),
        '益阳': (28.5701, 112.3550),
        '郴州': (25.7709, 113.0155),
        '永州': (26.4204, 111.6085),
        '怀化': (27.5500, 109.9982),
        '娄底': (27.7281, 111.9940),
        '湘西': (28.3115, 109.7397),
        '韶关': (24.8013, 113.5911),
        '珠海': (22.2711, 113.5767),
        '汕头': (23.3540, 116.6818),
        '佛山': (23.0218, 113.1219),
        '江门': (22.5751, 113.0816),
        '湛江': (21.2749, 110.3594),
        '茂名': (21.6687, 110.9253),
        '肇庆': (23.0517, 112.4656),
        '惠州': (23.1114, 114.4152),
        '梅州': (24.2996, 116.1187),
        '汕尾': (22.7739, 115.3640),
        '河源': (23.7460, 114.7005),
        '阳江': (21.8590, 111.9826),
        '清远': (23.6817, 113.0510),
        '东莞': (23.0489, 113.7447),
        '中山': (22.5157, 113.3924),
        '潮州': (23.6618, 116.6227),
        '揭阳': (23.5479, 116.3720),
        '云浮': (22.9150, 112.0440),
        '柳州': (24.3146, 109.4281),
        '桂林': (25.2736, 110.2900),
        '梧州': (23.4853, 111.2974),
        '北海': (21.4734, 109.1205),
        '防城港': (21.6146, 108.3538),
        '钦州': (21.9670, 108.6544),
        '贵港': (23.0936, 109.6027),
        '玉林': (22.6314, 110.1549),
        '百色': (23.9024, 106.6003),
        '贺州': (24.4140, 111.5693),
        '河池': (24.6956, 108.0623),
        '来宾': (23.7338, 109.2287),
        '崇左': (22.4041, 107.3647),
        '三亚': (18.2528, 109.5117),
        '海口': (20.0444, 110.1999),
        '贵阳': (26.6477, 106.6302),
        '六盘水': (26.5918, 104.8308),
        '遵义': (27.7066, 106.9336),
        '安顺': (26.2455, 105.9473),
        '毕节': (27.3017, 105.2887),
        '铜仁': (27.7183, 109.1914),
        '黔西南': (25.0877, 104.9065),
        '黔东南': (26.5837, 107.9774),
        '黔南': (26.2580, 107.5221),
        '绵阳': (31.4678, 104.6794),
        '德阳': (31.1270, 104.3979),
        '南充': (30.8378, 106.1110),
        '广安': (30.4564, 106.6333),
        '遂宁': (30.5332, 105.5713),
        '内江': (29.5804, 105.0582),
        '乐山': (29.5647, 103.7608),
        '眉山': (30.0476, 103.8313),
        '宜宾': (28.7602, 104.6431),
        '广元': (32.4333, 105.8229),
        '达州': (31.2090, 107.5023),
        '雅安': (29.9997, 103.0135),
        '巴中': (31.8691, 106.7536),
        '资阳': (30.1229, 104.6419),
        '阿坝': (31.8998, 102.2218),
        '甘孜': (30.0555, 101.9638),
        '凉山': (27.8868, 102.2587),
        '六安': (31.7341, 116.5078),
        '宿州': (33.6341, 116.9641),
        '阜阳': (32.8986, 115.8045),
        '滁州': (32.3173, 118.3168),
        '马鞍山': (31.6894, 118.5066),
        '芜湖': (31.3260, 118.3721),
        '铜陵': (30.9409, 117.8161),
        '安庆': (30.5255, 117.0537),
        '黄山': (29.7344, 118.3375),
        '宣城': (30.9456, 118.7419),
        '池州': (30.6600, 117.4890),
        '亳州': (33.8712, 115.7825),
        '淮南': (32.6264, 117.0182),
        '淮北': (33.9551, 116.7968),
        '蚌埠': (32.9165, 117.3889),
        '宿迁': (33.9520, 118.2757),
        '泰州': (32.4840, 119.9153),
        '淮安': (33.5975, 119.1523),
        '盐城': (33.3776, 120.1248),
        '连云港': (34.5972, 119.2216),
        '徐州': (34.2058, 117.1841),
        '莆田': (25.4310, 119.0078),
        '三明': (26.2654, 117.6090),
        '泉州': (24.8740, 118.6758),
        '漳州': (24.5107, 117.6472),
        '南平': (26.6410, 118.1776),
        '龙岩': (25.0916, 117.0174),
        '宁德': (26.6617, 119.5274),
        '景德镇': (29.2739, 117.1780),
        '萍乡': (27.6226, 113.8520),
        '九江': (29.7050, 115.9856),
        '新余': (27.8175, 114.9308),
        '鹰潭': (28.2386, 117.0696),
        '赣州': (25.8452, 114.9353),
        '吉安': (27.1138, 114.9865),
        '宜春': (27.8043, 114.3916),
        '抚州': (27.9544, 116.3581),
        '上饶': (28.4444, 117.9434),
        '德州': (37.4513, 116.3574),
        '聊城': (36.4563, 116.0373),
        '滨州': (37.3830, 118.0168),
        '菏泽': (35.2461, 115.4697),
        '临沂': (35.1041, 118.3563),
        '枣庄': (34.8107, 117.3239),
        '东营': (37.4610, 118.6748),
        '烟台': (37.4638, 121.4478),
        '潍坊': (36.7069, 119.1619),
        '济宁': (35.4154, 116.5874),
        '泰安': (36.1948, 117.0875),
        '威海': (37.5128, 122.1200),
        '日照': (35.4164, 119.4613),
        '莱芜': (36.2336, 117.6751),
        '临沭': (34.9192, 118.6508),
        '洛阳': (34.6197, 112.4539),
        '开封': (34.7972, 114.3074),
        '平顶山': (33.7453, 113.3078),
        '安阳': (36.0986, 114.3929),
        '鹤壁': (35.8993, 114.1929),
        '新乡': (35.3026, 113.9268),
        '焦作': (35.2159, 113.2416),
        '濮阳': (35.7617, 115.0414),
        '许昌': (34.0357, 113.8516),
        '漯河': (33.5817, 114.0460),
        '三门峡': (34.7833, 111.2000),
        '南阳': (32.9909, 112.5283),
        '商丘': (34.4141, 115.6506),
        '信阳': (32.1468, 114.0672),
        '周口': (33.6204, 114.6496),
        '驻马店': (32.9801, 114.0245),
        '荆州': (30.3269, 112.2386),
        '宜昌': (30.7019, 111.2906),
        '十堰': (32.6470, 110.7980),
        '孝感': (30.9264, 113.9269),
        '荆门': (31.0354, 112.2048),
        '鄂州': (30.3848, 114.8953),
        '黄石': (30.2200, 115.0770),
        '咸宁': (29.8426, 114.3221),
        '随州': (31.6902, 113.3741),
        '恩施': (30.2721, 109.4888),
        '仙桃': (30.3645, 113.4531),
        '潜江': (30.4210, 112.8969),
        '天门': (30.6531, 113.1658),
        '神农架': (31.7444, 110.6719),
        '株洲': (27.8274, 113.1516),
        '湘潭': (27.8299, 112.9445),
        '衡阳': (26.8981, 112.6071),
        '邵阳': (27.2378, 111.4669),
        '岳阳': (29.3570, 113.1282),
        '汉中': (33.0777, 107.0283),
        '延安': (36.5853, 109.4890),
        '榆林': (38.2790, 109.7341),
        '渭南': (34.5000, 109.5090),
        '商洛': (33.8739, 109.9408),
        '安康': (32.6840, 109.0290),
        '宝鸡': (34.3640, 107.2370),
        '咸阳': (34.3292, 108.7057),
        '铜川': (34.9083, 108.9450),
        '酒泉': (39.7320, 98.4940),
        '张掖': (38.9248, 100.4498),
        '武威': (37.9289, 102.6380),
        '白银': (36.5448, 104.1380),
        '金昌': (38.5142, 102.1880),
        '天水': (34.5845, 105.7245),
        '陇南': (33.4005, 104.9211),
        '定西': (35.5796, 104.6260),
        '平凉': (35.5436, 106.6650),
        '庆阳': (35.7342, 107.6430),
        '临夏': (35.5992, 103.2110),
        '甘南': (34.9863, 102.9110),
        '海东': (36.5029, 102.1040),
        '海北': (36.9594, 100.9010),
        '黄南': (35.5177, 102.0199),
        '海南': (36.2803, 100.6199),
        '果洛': (34.4736, 100.2420),
        '玉树': (33.0037, 97.0086),
        '海西': (37.3749, 97.3708),
        '石嘴山': (39.0333, 106.3833),
        '吴忠': (37.9979, 106.1992),
        '固原': (36.0154, 106.2430),
        '中卫': (37.4999, 105.1965),
        '吐鲁番': (42.9513, 89.1896),
        '哈密': (42.8330, 93.5130),
        '昌吉': (44.0142, 87.3040),
        '博州': (44.9058, 82.0665),
        '巴州': (41.7686, 86.1500),
        '阿克苏': (41.1717, 80.2648),
        '克州': (39.7130, 76.1676),
        '喀什': (39.4677, 75.9930),
        '和田': (37.1100, 79.9300),
        '伊犁': (43.9186, 81.3170),
        '塔城': (46.7461, 82.9859),
        '阿勒泰': (47.8484, 88.1396),
        '克拉玛依': (45.5950, 84.8890),
        '五家渠': (44.1673, 87.5268),
        '阿拉尔': (40.5420, 81.2866),
        '图木舒克': (39.8674, 79.0784),
        '可克达拉': (44.0342, 80.6300),
        '昆玉': (37.2070, 79.2360),
        '胡杨河': (44.6889, 84.8253),
        '新星': (44.3737, 85.1328),
        '白沙': (19.2246, 109.4515),
        '保亭': (18.6360, 109.7020),
        '昌江': (19.2608, 109.0328),
        '澄迈': (19.7370, 110.0070),
        '定安': (19.6845, 110.3590),
        '东方': (19.1025, 108.6534),
        '乐东': (18.7479, 109.1750),
        '临高': (19.9087, 109.6872),
        '陵水': (18.5057, 110.0370),
        '琼海': (19.2463, 110.4661),
        '琼中': (19.0356, 109.8396),
        '屯昌': (19.3629, 110.1026),
        '万宁': (18.7962, 110.3893),
        '文昌': (19.6124, 110.7537),
        '五指山': (18.7769, 109.5169),
        '儋州': (19.5175, 109.5770),
        '三沙': (16.8309, 112.3482),
        '香港': (22.3193, 114.1694),
        '澳门': (22.1987, 113.5439),
        '台北': (25.0330, 121.5654),
        '高雄': (22.6273, 120.3014),
        '台中': (24.1477, 120.6736),
        '台南': (22.9999, 120.2270),
        '新北': (25.0118, 121.4627),
        '桃园': (24.9936, 121.3010),
        '基隆': (25.1276, 121.7392),
        '新竹': (24.8138, 120.9675),
        '苗栗': (24.5602, 120.8214),
        '彰化': (24.0518, 120.5161),
        '南投': (23.9609, 120.9719),
        '云林': (23.7092, 120.4313),
        '嘉义': (23.4801, 120.4491),
        '屏东': (22.6689, 120.4883),
        '宜兰': (24.7019, 121.7378),
        '花莲': (23.9871, 121.6015),
        '台东': (22.7972, 121.1713),
        '澎湖': (23.5711, 119.5791),
        '金门': (24.4491, 118.3770),
        '连江': (26.1565, 119.9395),
    }
    
    # 简化匹配，移除省市后缀
    for suffix in ['市', '县', '区', '省']:
        if city_name.endswith(suffix):
            city_name = city_name[:-1]
    
    # 尝试直接匹配
    if city_name in city_coords:
        return city_coords[city_name]
    
    # 尝试部分匹配
    for city, coords in city_coords.items():
        if city_name in city or city in city_name:
            return coords
    
    # 如果没有找到，返回北京坐标作为默认值
    return (39.9042, 116.4074)

def add_coordinates_to_places():
    """为地点数据添加坐标信息"""
    
    # 读取当前的places.json文件
    with open('data/processed/places.json', 'r', encoding='utf-8') as f:
        places = json.load(f)
    
    print(f"开始为 {len(places)} 个地点添加坐标...")
    
    # 统计相同地点以减少重复查询
    unique_places = defaultdict(list)
    
    for i, place in enumerate(places):
        city_key = place.get('city', place.get('modern_name', ''))
        unique_places[city_key].append(i)
    
    print(f"找到 {len(unique_places)} 个唯一地点")
    
    # 为每个唯一地点获取坐标
    for city_name, indices in unique_places.items():
        if not city_name or city_name == 'nan':
            continue
            
        lat, lng = get_coordinates_from_city_name(city_name)
        
        # 更新所有相同地点的坐标
        for idx in indices:
            places[idx]['lat'] = lat
            places[idx]['lng'] = lng
        
        print(f"已处理: {city_name} -> ({lat}, {lng})")
        
        # 添加小延时避免过于频繁的请求
        time.sleep(0.1)
    
    # 保存更新后的数据
    with open('data/processed/places.json', 'w', encoding='utf-8') as f:
        json.dump(places, f, ensure_ascii=False, indent=2)
    
    print("坐标添加完成！")

if __name__ == "__main__":
    add_coordinates_to_places()